---
title: "Secure Email From Java"
date: 2013-01-14T19:09:52-06:00
draft: false
image: ""
tags: [bouncycastle, certificate, email, encrypt, ewallet, java, javamail, jks, orapki, pfx, pkcs12, s/mime, secure, sign, signed, wallet]
---

Cross-posted from link:https://blogs.oracle.com/javajungle/entry/secure_email_from_java[The Java Jungle] by Mark Heckler

Iâ€™ve been working recently with a client to do some rather useful things with notifications, and one of them involved sending a secure email from within a Java program. We encountered some interesting (translation: weird!) challenges, and in overcoming them, I worked out a reasonably straightforward path through the minefield. If youâ€™ve been thinking about secure-email-enabling your Java app but arenâ€™t sure where to start, hopefully this will serve as a fairly quick and mostly painless primer. Â ğŸ™‚

== The Problem

Let me first say that if you only want to send a plain-text email from Java, there are ways to do that without much fuss and without any external players. If you want to sign or encrypt your emails, though, youâ€™ll need a couple of extra components:

. A digital certificate (private/public key pair issued by a recognized Certificate Authority, or â€œCAâ€)
. A means of using the certificate to sign and/or encrypt the email

he goal is to digitally sign an email to assure recipients that the sender of the mail is indeed me (or you, if youâ€™re following along at work/home). Letâ€™s get started!

== Getting Your Tools in Order

=== Getting a Certificate

First, we have to have a digital certificate. If you already have one, you can skip this stepâ€¦but if not, StartSSL offers free user/email certificates for personal use. Just point your browser to link:https://www.startssl.com/?app=12[the StartSSL site] and click the large button labeled â€œSign-upâ€. Youâ€™ll need to provide some information, enter the verification code they email to the address you provide, and they do the rest...including installing your new cert and the certificate chain into your web browser.

=== Freeing the Certificate from your Browser

Perhaps the easiest way to use a certificate is to store it (keys, certificate chain) in a Java Keystore (jks). Extracting your shiny new certificate from your browser is a relatively easy (albeit drawn-out) process.Â From your browser, export your certificate,Â *including private key*. This will produce a .pfx file, which is a PKCS12 keystore. From Chrome, you simply:

. Click on the Wrench (or Lines) icon in the upper-right corner
. Select â€œSettingsâ€ from the menu
. â€œShow advanced settingsâ€¦â€ at the bottom of the page
. Scroll down to the section labeled â€œHTTPS/SSLâ€
. Click the "Manage certificates..." button to display your certificates.

Then, from the certificates window:

. Select the target certificate and click the â€œExport...â€ button
. Click â€œNextâ€ from the Export Wizard window
. Choose â€œYes, export the private keyâ€ and click â€œNextâ€
. Under the â€œPersonal Information Exchange â€“ PKCS #12 (.PFX)â€ entry, select the options to â€œInclude all certificates in the certification path if possibleâ€ and â€œExport all extended propertiesâ€ (NOTE: Do NOT choose to â€œDelete the private key if the export is successfulâ€. No no no!) and click â€œNextâ€
. Enter a password (twice) and click â€œNextâ€
. Provide a path/filename for the export and click â€œNextâ€, and finallyâ€¦
. Confirm the export options and click â€œFinishâ€.

Now that weâ€™ve liberated your cert from the browser, letâ€™s make it usable by our (non-browser) Java program.

=== Creating a Java Keystore

The fastest, easiest way Iâ€™ve found to convert a .pfx file to a .jks (Java Keystore) file is with the Oracle 11g database client. The database client can be downloaded by link:http://www.oracle.com/technetwork/database/enterprise-edition/downloads/index.html[following this link], selecting the â€œSee Allâ€ link to the right of your listed operating system, and choosing the 11g client from the OS-specific download page. Once itâ€™s downloaded and installed, youâ€™re ready to proceed.

Like the .pfx file, the Oracle wallet is a PKCS12 keystore, and the orapki utility (and other tools) included with the database client can be used to manipulate itâ€¦as long as it thinks itâ€™s dealing with an Oracle wallet. To make that happen, simply rename the .pfx file to **ewallet.p12**. Since we arenâ€™t dealing with the Oracle Wallet Manager, we donâ€™t have to worry about meeting OWMâ€™s password criteria or other niceties. Yes, that really is all there is to it!

Now, to make a Java Keystore. To do that, youâ€™ll need to open a command prompt and do the following tasks:

. Create an ORACLE_HOME environment variable that points to the install location of the Oracle client
. Run the following command, pointing to the orapki utility under %ORACLE_HOME%\bin (in Windows) or $ORACLE_HOME/bin (Mac/Linux/UNIX):

----
orapki wallet pkcs12_to_jks -wallet <wallet_directory> -pwdÂ <wallet_password>Â -jksKeyStoreLoc <java_key_store_path_and_filename>Â -jksKeyStorepwd <jks_password>
----

You should now have a brand new Java KeyStore! You can verify its contents with the OpenSSL keytool utility:

----
keytool -list -keystore <java_key_store>
----

Now that we have our credentials in order, on to the Java side of things!

== Building the Solution

There are several Java libraries available that aid in signing and/or encrypting email. Of the non-commercial options I found, all use theÂ link:http://www.bouncycastle.org/[*Bouncy Castle Crypto APIÂ *] link:http://www.bouncycastle.org/[and libraries] as their underpinnings. Bouncy Castle (BC) may have a funny name, but itâ€™s all business with regard to encryption. At a very high level, you need to do the following things to create/send a signed email:

. Provide the email â€œessentialsâ€: SMTP server host & port, email addresses (sender & receiver), a subject, content, and the sending userâ€™s password
. Add BC as a new crypto provider
. Retrieve the cert from your Java Keystore
. Create and sign the email using the BC API/libraries
. Send the email

There is much more you can do of course, but these are the â€œmust-havesâ€.

In preparation for developing our secure email module, I created a proof of concept (BCCrypTool) by marryingÂ a Java email program Iâ€™d written previously and some BC sample code...code reuse at its lowest level, but still good for the environment. ğŸ™‚ What you see link:https://github.com/hecklerm/BCCrypTool[here in my GitHub repo] is a bit of streamlined Java code that should be pretty easy to repurpose. Please feel free to take a copy and do just that, and if you make significant changes/improvements and are able and inclined to share them, please feel free to do that as well. Sharing is caring. Â ğŸ™‚

A quick note on libraries. Youâ€™ll need the following to make this work:

From link:http://www.oracle.com/technetwork/java/javamail/index.html[JavaMail]:

* mail.jar

If using Java older than SE 6, youâ€™ll also need the link:http://www.oracle.com/technetwork/java/javase/index-jsp-136939.html[JavaBeans Activation Framework]:

* activation.jar

And link:http://www.bouncycastle.org/latest_releases.html[from Bouncy Castle], the following:

* The BC provider library (bcprov-jdk15on-147.jar)
* The BC S/MIME library (bcmail-jdk15on-147.jar)
* The BC security library (bcpkix-jdk15on-147.jar)

There are link:http://www.bouncycastle.org/latest_releases.html[other BC libraries available here] if youâ€™d like to take things even further.

All the best to you in your Java secure email adventures!

Mark
